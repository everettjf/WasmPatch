# AGENT Guide

## Project Summary
WasmPatch is an Objective-C/Objective-C++ runtime bridge that lets you compile C patches into WebAssembly modules and load them inside iOS or macOS apps. The wasm payload can invoke or replace Objective-C methods at runtime, enabling hotfixes without shipping a new binary.

## Repo Map
- `WasmPatch/Classes/` – Core library sources (`WasmPatch.h/.mm` plus the `wap` runtime and dependencies such as libffi).
- `Demo/` – Sample Xcode workspaces (`WasmPatch-iOS`, `WasmPatch-macOS`) and `podinstall_all.sh` to install their CocoaPods dependencies.
- `TestCase/` – Reference wasm patch project (`WasmPatch-TestCase`) plus `compile-testcase.sh` that builds `Assets/script.bundle/objc.c` using the toolchain.
- `Tool/` – Helper scripts:
  - `install-llvm.sh` installs LLVM/clang via Homebrew.
  - `c2wasm.sh` compiles a C source file to `.wasm` and `.wat`.
- `Image/` – Documentation assets (architecture diagram, WeChat QR code) used in the README.
- `WasmPatch.podspec` & `WasmPatch-TestCase.podspec` – CocoaPods specifications defining deployment targets and build settings.

## Common Commands
- Install prerequisites: `brew update && brew install llvm` (or `sh Tool/install-llvm.sh`).
- Build a C patch to WebAssembly: `./Tool/c2wasm.sh input.c output.wasm`.
- Compile the sample testcase: `cd TestCase && sh compile-testcase.sh` (invokes `Tool/c2wasm.sh` internally).
- Install demo pod dependencies: `cd Demo && sh podinstall_all.sh`.
- Run demos: open `Demo/WasmPatch-iOS/WasmPatch-iOS.xcworkspace` or `Demo/WasmPatch-macOS/WasmPatch-macOS.xcworkspace` in Xcode and run the appropriate scheme.
- Manual integration reminder: add `WasmPatch/Classes/wap/depend/libffi/include` to Header Search Paths when dragging sources into a project.

Testing/linting scripts are not provided; rely on the demo workspaces and Xcode's build system to validate changes.

## Code Style & Conventions
- Languages: Objective-C, Objective-C++, C/C++, and WebAssembly text output.
- Formatting: follow existing style in `WasmPatch/Classes`; default suggestion is to use Xcode's formatting or `clang-format` (please note this is a default suggestion, not an enforced rule).
- Compiler settings: target C++17 with `libc++` (matches the podspec).
- Commit messages: concise imperative statements (<72 chars) are recommended (default suggestion; no formal guideline exists).

## Modification Principles
- Favor incremental changes and small, reviewable PRs.
- Keep demos and documentation (especially `README.md`) in sync with behavior changes.
- Add or update sample wasm scripts/tests when modifying runtime APIs.
- Avoid drive-by refactors; keep unrelated cleanup out of focused changesets.

## Debugging & Troubleshooting
- If wasm fails to load, log the resolved script path (`wap_load_file`) to ensure `objc.wasm` exists inside the bundle.
- Use the `.wat` output generated by `c2wasm.sh` (via `wasm2wat`) to verify exported symbols when debugging.
- When CocoaPods integration fails, rerun `pod install` inside each demo directory; delete `Pods/` only if necessary.
- Linking issues typically mean `WasmPatch/Classes/wap/depend/libffi/include` or `libc++` was not added to the target settings.
- Re-run `sh Tool/install-llvm.sh` after macOS/Xcode upgrades to ensure the wasm toolchain is on PATH.

## PR Checklist
- [ ] Install/refresh dependencies (`brew install llvm`, `pod install`) and ensure the demos build.
- [ ] Regenerate wasm artifacts with `./Tool/c2wasm.sh` or `sh TestCase/compile-testcase.sh` if the patch source changes.
- [ ] Update documentation (`README.md`, comments, demo instructions) when behavior or commands change.
- [ ] Run the relevant demo(s) to verify that patches load and Objective-C methods behave as expected.
- [ ] Confirm licensing headers remain intact and acknowledge external dependencies when adding new ones.
